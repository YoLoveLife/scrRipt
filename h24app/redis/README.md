# Redis Cluster
## Introduce
Redis集群 由最低6个节点组成

在新闻24小时的环境中 Redis集群由两台主机分别组成

每台主机包含了6个Redis节点

Redis服务节点端口[8081-8086]

由于Redis集群的数据交换需求 总线端口[18081-18082]

## Explain
在Redis集群中 保证的是服务可用

所以Redis集群是没有办法进行重启操作的

并且在新闻24小时环境中 支持12个节点中 6个主节点的丢失出错

如果出现一个哈希池主从节点都丢失 则集群业务失效

则需要将所有集群服务关闭 重新部署

所以在代码的书写上 要求对于Redis的数据丢失有所准备

如果出现Redis中数据丢失 代码中应该具有数据库重读的功能


## Info
与Redis集群相关的目录：
* /usr/local/redis Redis部署目录
* /usr/local/redis/clusterConf 集群配置信息
* /usr/lib/ruby/gems/1.8/gems/redis-3.2.2 集群ruby插件
* /storage/redis 集群持续化文件目录
* ~/h24app-redis-redeploy 重新部署脚本

## Operation
应对Redis集群的重新部署：

重新部署有几个先决条件
* 集群Redis服务全部关闭
* 保留Redis部署目录(基础目录)
* 删除集群配置信息
* 集群ruby插件lib/下删除
* 集群持续化文件删除

以上先决条件保证部署的环境

重新部署操作
* 执行~/h24app-redis-redeploy/redeploy.sh脚本(root用户执行)

执行完毕后 会自动批量开启Redis集群的节点

需要通过命令来将集群哈希槽分配将集群启动起来

防火墙由于之前保留了配置 所以可以不用修改

重新部署之后会有信息输出

信息输出内容是一行List 内容是该主机上的所有Redis节点

在其中一台主机上执行分配启动集群操作

示例
* /usr/local/redis/src/redis-trib.rb create --replicas 1 10.200.76.31:8086 10.200.76.31:8085 10.200.76.31:8084 10.200.76.31:8083 10.200.76.31:8082 10.200.76.31:8081 10.200.76.32:8086 10.200.76.32:8085 10.200.76.32:8084 10.200.76.32:8083 10.200.76.32:8082 10.200.76.32:8081

这里包含了集群所有的节点信息 此处的IP根据具体环境不同进行更改 重新部署脚本执行后也会生成列表 直接粘贴也可以